{{- if .Values.externalSecrets.clusterSecretStore }}
{{- $chains := splitList "," .Values.hyperlane.chains }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "shovel.fullname" . }}-env-var-secret
  labels:
    {{- include "shovel.labels" . | nindent 4 }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: {{ .Values.externalSecrets.clusterSecretStore }}
    kind: ClusterSecretStore
  target:
    name: {{ include "shovel.fullname" . }}-env-var-secret
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        {{- if .Values.externalSecrets.databaseUrlSecretKey }}
        DATABASE_URL: "{{ "{{ .database_url }}" }}"
        {{- end }}
{{/*
   * For each chain, create HYP_RPC_<CHAIN> environment variable.
   * The config generator reads these to set Shovel's eth_sources URLs.
   * Uses the first URL from the JSON array stored in GCP Secret Manager.
   */}}
        {{- range $chains }}
        {{- $chain := . | trim }}
        {{- if $chain }}
        HYP_RPC_{{ $chain | upper | replace "-" "_" }}: {{ printf "'{{ index (.%s_rpcs | fromJson) 0 }}'" $chain }}
        {{- end }}
        {{- end }}
  data:
    {{- if .Values.externalSecrets.databaseUrlSecretKey }}
    - secretKey: database_url
      remoteRef:
        key: {{ .Values.externalSecrets.databaseUrlSecretKey }}
    {{- end }}
{{/*
   * For each chain, load the GCP secret: {runEnv}-rpc-endpoints-{chain}
   */}}
    {{- range $chains }}
    {{- $chain := . | trim }}
    {{- if $chain }}
    - secretKey: {{ printf "%s_rpcs" $chain }}
      remoteRef:
        key: {{ printf "%s-rpc-endpoints-%s" $.Values.hyperlane.runEnv $chain }}
    {{- end }}
    {{- end }}
{{- end }}
