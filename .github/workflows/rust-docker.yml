name: Build and Push Agent Image to GCR
on:
  push:
    branches: [main]
    tags:
      - '**'
  pull_request:
    paths:
      - 'rust/**'
      - '.github/workflows/rust-docker.yml'
  workflow_dispatch:
    inputs:
      include_arm64:
        description: 'Include arm64 in the build'
        required: false
        default: 'false'
concurrency:
  group: build-push-agents-${{ github.ref }}
  cancel-in-progress: true
jobs:
  check-env:
    runs-on: ubuntu-latest
    # assign output from step to job output
    outputs:
      gcloud-service-key: ${{ steps.gcloud-service-key.outputs.defined }}
    steps:
      - id: gcloud-service-key
        # assign GCLOUD_SERVICE_KEY to env for access in conditional
        env:
          GCLOUD_SERVICE_KEY: ${{ secrets.GCLOUD_SERVICE_KEY }}
        if: "${{ env.GCLOUD_SERVICE_KEY != '' }}"
        # runs if GCLOUD_SERVICE_KEY is defined, so we set the output to true
        run: echo "defined=true" >> $GITHUB_OUTPUT

  build-and-push-to-gcr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      pull-requests: write

    # uses check-env to determine if secrets.GCLOUD_SERVICE_KEY is defined
    needs: [check-env]
    if: needs.check-env.outputs.gcloud-service-key == 'true'

    steps:
      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.HYPER_GONK_APP_ID }}
          private-key: ${{ secrets.HYPER_GONK_PRIVATE_KEY }}

      - uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Generate tag data
        id: taggen
        run: |
          set -euo pipefail
          TAG_SHA=$(echo '${{ github.event.pull_request.head.sha || github.sha }}' | cut -b 1-7)
          TAG_DATE=$(date +'%Y%m%d-%H%M%S')
          echo "TAG_SHA_DATE=${TAG_SHA}-${TAG_DATE}" >> $GITHUB_OUTPUT

          # Determine primary tag based on event type
          if [ "${{ github.ref_type }}" = "tag" ]; then
            echo "TAG=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            # Derive semver from tag
            NAME="${{ github.ref_name }}"
            NAME="${NAME#agents-}"
            NAME="${NAME#v}"
            if echo "$NAME" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+'; then
              echo "SEMVER=$NAME" >> $GITHUB_OUTPUT
              if echo "$NAME" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
                echo "SEMVER_MINOR=$(echo "$NAME" | sed -E 's/^([0-9]+\.[0-9]+)\.[0-9]+$/\1/')" >> $GITHUB_OUTPUT
              fi
            fi
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "TAG=pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "TAG=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

          # Determine platforms
          if [ "${{ github.event.inputs.include_arm64 }}" == "true" ]; then
            echo "PLATFORMS=linux/amd64,linux/arm64" >> $GITHUB_OUTPUT
          else
            echo "PLATFORMS=linux/amd64" >> $GITHUB_OUTPUT
          fi

      - name: Set up Depot CLI
        uses: depot/setup-action@v1

      - name: Login to GCR
        uses: docker/login-action@v3
        with:
          registry: gcr.io
          username: _json_key
          password: ${{ secrets.GCLOUD_SERVICE_KEY }}

      - name: Build and push all images
        id: build
        uses: depot/bake-action@v1
        env:
          TAG: ${{ steps.taggen.outputs.TAG }}
          TAG_SHA_DATE: ${{ steps.taggen.outputs.TAG_SHA_DATE }}
          SEMVER: ${{ steps.taggen.outputs.SEMVER }}
          SEMVER_MINOR: ${{ steps.taggen.outputs.SEMVER_MINOR }}
          PLATFORMS: ${{ steps.taggen.outputs.PLATFORMS }}
        with:
          project: czmkmn2km1
          files: rust/docker-bake.hcl
          push: true

      # Post PR comments for each image type
      - name: Comment image tags on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const tag = '${{ steps.taggen.outputs.TAG }}';
            const tagShaDate = '${{ steps.taggen.outputs.TAG_SHA_DATE }}';
            const registry = 'gcr.io/abacus-labs-dev';
            const status = '${{ job.status }}';
            const statusEmoji = status === 'success' ? 'âœ…' : 'âŒ';

            const images = [
              { name: 'Validator', image: 'hyperlane-agent-validator', emoji: 'âœï¸' },
              { name: 'Relayer', image: 'hyperlane-agent-relayer', emoji: 'ðŸš€' },
              { name: 'Scraper', image: 'hyperlane-agent-scraper', emoji: 'ðŸ“Š' },
              { name: 'Agent', image: 'hyperlane-agent', emoji: 'ðŸ¦€' },
            ];

            const imageLines = images.map(({ name, image, emoji }) => {
              const tags = [
                `${registry}/${image}:${tag}`,
                `${registry}/${image}:${tagShaDate}`,
              ];
              return `### ${emoji} ${name}\n\`\`\`\n${tags.join('\n')}\n\`\`\``;
            }).join('\n\n');

            const body = `## ${statusEmoji} Agent Docker Images

            ${imageLines}
            `.replace(/^ +/gm, '');

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.pull_request.number }},
            });

            const marker = '<!-- rust-docker-images -->';
            const existingComment = comments.find(c => c.body.includes(marker));
            const fullBody = `${marker}\n${body}`;

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: fullBody,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ github.event.pull_request.number }},
                body: fullBody,
              });
            }
