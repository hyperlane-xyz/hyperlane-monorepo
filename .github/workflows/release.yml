name: Release

on:
  push:
    branches:
      - main
      - pb/ci-yarn-testing
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

concurrency: ${{ github.workflow }}-${{ github.ref }}

env:
  LOG_FORMAT: PRETTY
  TURBO_TELEMETRY_DISABLED: 1
  TURBO_API: https://cache.depot.dev
  TURBO_TOKEN: ${{ secrets.DEPOT_TURBO_TOKEN }}
  TURBO_TEAM: ${{ secrets.DEPOT_ORG_ID }}

jobs:
  # If we detect that not all packages are published, we run the
  # cli-install-cross-platform-release-test workflow to verify that the CLI installs correctly on all platforms.
  # In all other cases, we already have a barebones `cli-install` test on the default CI platform
  # which will catch most issues before any offending PR is merged.
  cli-install-cross-platform-release-test:
    strategy:
      matrix:
        os: [depot-ubuntu-latest, depot-macos-latest, depot-windows-2022-8]
        node-version: [18, 19, 20, 21, 22, 23]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}

      - name: install-hyperlane-cli
        id: install-hyperlane-cli
        uses: ./.github/actions/install-cli
        with:
          ref: ${{ github.sha }}
          no-cache: true

      - name: Test run the CLI
        run: hyperlane --version
