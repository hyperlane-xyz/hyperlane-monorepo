name: Build and Push Node Services Images to GCR

on:
  push:
    branches: [main]
    tags:
      - '**'
  pull_request:
    paths:
      - 'typescript/rebalancer/**'
      - 'typescript/warp-monitor/**'
      - 'typescript/ccip-server/**'
      - 'typescript/keyfunder/**'
      - 'typescript/relayer/**'
      - 'typescript/Dockerfile.node-service'
      - 'typescript/Dockerfile.node-service-runner'
      - 'pnpm-lock.yaml'
      - '.github/workflows/node-services-docker.yml'
      - 'typescript/docker-bake.hcl'
  workflow_dispatch:
    inputs:
      include_arm64:
        description: 'Include arm64 in the build'
        required: false
        default: 'false'

concurrency:
  group: build-push-node-services-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-env:
    runs-on: ubuntu-latest
    outputs:
      gcloud-service-key: ${{ steps.gcloud-service-key.outputs.defined }}
    steps:
      - id: gcloud-service-key
        env:
          GCLOUD_SERVICE_KEY: ${{ secrets.GCLOUD_SERVICE_KEY }}
        if: "${{ env.GCLOUD_SERVICE_KEY != '' }}"
        run: echo "defined=true" >> $GITHUB_OUTPUT

  build-bundles:
    runs-on: depot-ubuntu-24.04-8
    needs: [check-env]
    if: needs.check-env.outputs.gcloud-service-key == 'true'

    env:
      TURBO_API: https://cache.depot.dev
      TURBO_TOKEN: ${{ secrets.DEPOT_TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.DEPOT_ORG_ID }}

    outputs:
      tag: ${{ steps.taggen.outputs.TAG }}
      tag_sha_date: ${{ steps.taggen.outputs.TAG_SHA_DATE }}
      platforms: ${{ steps.taggen.outputs.PLATFORMS }}

    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          submodules: recursive
          fetch-depth: 0

      - name: Generate tag data
        id: taggen
        run: |
          set -euo pipefail
          TAG_SHA=$(echo '${{ github.event.pull_request.head.sha || github.sha }}' | cut -b 1-7)
          TAG_DATE=$(date +'%Y%m%d-%H%M%S')
          echo "TAG_SHA_DATE=${TAG_SHA}-${TAG_DATE}" >> $GITHUB_OUTPUT

          # Determine primary tag based on event type
          if [ "${{ github.ref_type }}" = "tag" ]; then
            echo "TAG=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "TAG=pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "TAG=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

          # Determine platforms
          if [ "${{ github.event.inputs.include_arm64 }}" == "true" ]; then
            echo "PLATFORMS=linux/amd64,linux/arm64" >> $GITHUB_OUTPUT
          else
            echo "PLATFORMS=linux/amd64" >> $GITHUB_OUTPUT
          fi

          # Get Foundry version
          echo "FOUNDRY_VERSION=$(cat solidity/.foundryrc)" >> $GITHUB_OUTPUT

      - name: Setup Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: ${{ steps.taggen.outputs.FOUNDRY_VERSION }}

      - name: pnpm cache
        uses: ./.github/actions/pnpm-cache

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build and bundle all services
        run: |
          pnpm turbo run bundle \
            --filter=@hyperlane-xyz/rebalancer \
            --filter=@hyperlane-xyz/warp-monitor \
            --filter=@hyperlane-xyz/ccip-server \
            --filter=@hyperlane-xyz/keyfunder \
            --filter=@hyperlane-xyz/relayer

      - name: Upload bundles artifact
        uses: actions/upload-artifact@v4
        with:
          name: service-bundles
          retention-days: 1
          path: |
            typescript/rebalancer/bundle
            typescript/warp-monitor/bundle
            typescript/ccip-server/bundle
            typescript/keyfunder/bundle
            typescript/relayer/bundle

  build-and-push-to-gcr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      pull-requests: write

    needs: [build-bundles]

    steps:
      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.HYPER_GONK_APP_ID }}
          private-key: ${{ secrets.HYPER_GONK_PRIVATE_KEY }}

      - uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          sparse-checkout: |
            typescript/docker-bake.hcl
            typescript/Dockerfile.node-service-runner
            pnpm-workspace.yaml
          sparse-checkout-cone-mode: false

      - name: Download bundles artifact
        uses: actions/download-artifact@v4
        with:
          name: service-bundles
          path: typescript

      - name: Set up Depot CLI
        uses: depot/setup-action@v1

      - name: Login to GCR
        uses: docker/login-action@v3
        with:
          registry: gcr.io
          username: _json_key
          password: ${{ secrets.GCLOUD_SERVICE_KEY }}

      - name: Build and push all images
        id: build
        uses: depot/bake-action@v1
        env:
          TAG: ${{ needs.build-bundles.outputs.tag }}
          TAG_SHA_DATE: ${{ needs.build-bundles.outputs.tag_sha_date }}
          PLATFORMS: ${{ needs.build-bundles.outputs.platforms }}
          SERVICE_VERSION: ${{ needs.build-bundles.outputs.tag_sha_date }}
        with:
          project: 3cpjhx94qv
          files: typescript/docker-bake.hcl
          push: true

      - name: Generate image tags output
        id: image-tags
        if: always()
        run: |
          TAG="${{ needs.build-bundles.outputs.tag }}"
          TAG_SHA_DATE="${{ needs.build-bundles.outputs.tag_sha_date }}"
          REGISTRY="gcr.io/abacus-labs-dev"

          if [ "${{ steps.build.outcome }}" == "success" ]; then
            # Generate tags for comment action (SHA-date only)
            TAGS=$(cat << EOF
          ${REGISTRY}/hyperlane-rebalancer:${TAG_SHA_DATE}
          ${REGISTRY}/hyperlane-warp-monitor:${TAG_SHA_DATE}
          ${REGISTRY}/hyperlane-key-funder:${TAG_SHA_DATE}
          ${REGISTRY}/hyperlane-ts-relayer:${TAG_SHA_DATE}
          ${REGISTRY}/hyperlane-offchain-lookup-server:${TAG_SHA_DATE}
          EOF
            )
            echo "tags<<EOF" >> $GITHUB_OUTPUT
            echo "$TAGS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            # Write job summary
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ## âš™ï¸ Node Service Docker Images

          | Service | Tag |
          |---------|-----|
          | â™»ï¸ rebalancer | \`${TAG_SHA_DATE}\` |
          | ðŸ•µï¸ warp-monitor | \`${TAG_SHA_DATE}\` |
          | ðŸ”‘ key-funder | \`${TAG_SHA_DATE}\` |
          | ðŸš€ ts-relayer | \`${TAG_SHA_DATE}\` |
          | ðŸ” offchain-lookup-server | \`${TAG_SHA_DATE}\` |

          **Full image paths:**
          \`\`\`
          ${TAGS}
          \`\`\`
          EOF
          else
            echo "tags=" >> $GITHUB_OUTPUT
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ## âš™ï¸ Node Service Docker Images

          âŒ **Build failed** - no images were pushed.
          EOF
          fi

      - name: Comment image tags on PR
        if: github.event_name == 'pull_request' && always()
        uses: ./.github/actions/docker-image-comment
        with:
          comment_tag: typescript-docker-images
          image_name: Node Service Docker Images
          emoji: 'âš™ï¸'
          image_tags: ${{ steps.image-tags.outputs.tags }}
          pr_number: ${{ github.event.pull_request.number }}
          github_token: ${{ steps.generate-token.outputs.token }}
          job_status: ${{ job.status }}
