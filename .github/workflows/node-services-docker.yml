name: Build and Push Node Services Images to GCR

on:
  push:
    branches: [main]
    tags:
      - '**'
  pull_request:
    paths:
      - 'typescript/rebalancer/**'
      - 'typescript/warp-monitor/**'
      - 'typescript/ccip-server/**'
      - 'typescript/keyfunder/**'
      - 'typescript/relayer/**'
      - 'typescript/Dockerfile.node-service'
      - 'pnpm-lock.yaml'
      - '.github/workflows/node-services-docker.yml'
      - 'typescript/docker-bake.hcl'
  workflow_dispatch:
    inputs:
      include_arm64:
        description: 'Include arm64 in the build'
        required: false
        default: 'false'

concurrency:
  group: build-push-node-services-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-env:
    runs-on: ubuntu-latest
    outputs:
      gcloud-service-key: ${{ steps.gcloud-service-key.outputs.defined }}
    steps:
      - id: gcloud-service-key
        env:
          GCLOUD_SERVICE_KEY: ${{ secrets.GCLOUD_SERVICE_KEY }}
        if: "${{ env.GCLOUD_SERVICE_KEY != '' }}"
        run: echo "defined=true" >> $GITHUB_OUTPUT

  build-and-push-to-gcr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      pull-requests: write

    needs: [check-env]
    if: needs.check-env.outputs.gcloud-service-key == 'true'

    steps:
      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.HYPER_GONK_APP_ID }}
          private-key: ${{ secrets.HYPER_GONK_PRIVATE_KEY }}

      - uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          submodules: recursive
          fetch-depth: 0

      - name: Generate tag data
        id: taggen
        run: |
          set -euo pipefail
          TAG_SHA=$(echo '${{ github.event.pull_request.head.sha || github.sha }}' | cut -b 1-7)
          TAG_DATE=$(date +'%Y%m%d-%H%M%S')
          echo "TAG_SHA_DATE=${TAG_SHA}-${TAG_DATE}" >> $GITHUB_OUTPUT

          # Determine primary tag based on event type
          if [ "${{ github.ref_type }}" = "tag" ]; then
            echo "TAG=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "TAG=pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "TAG=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

          # Determine platforms
          if [ "${{ github.event.inputs.include_arm64 }}" == "true" ]; then
            echo "PLATFORMS=linux/amd64,linux/arm64" >> $GITHUB_OUTPUT
          else
            echo "PLATFORMS=linux/amd64" >> $GITHUB_OUTPUT
          fi

          # Get Foundry version
          FOUNDRY_VERSION=$(cat solidity/.foundryrc)
          echo "FOUNDRY_VERSION=$FOUNDRY_VERSION" >> $GITHUB_OUTPUT

      - name: Set up Depot CLI
        uses: depot/setup-action@v1

      - name: Login to GCR
        uses: docker/login-action@v3
        with:
          registry: gcr.io
          username: _json_key
          password: ${{ secrets.GCLOUD_SERVICE_KEY }}

      - name: Build and push all images
        id: build
        uses: depot/bake-action@v1
        env:
          TAG: ${{ steps.taggen.outputs.TAG }}
          TAG_SHA_DATE: ${{ steps.taggen.outputs.TAG_SHA_DATE }}
          PLATFORMS: ${{ steps.taggen.outputs.PLATFORMS }}
          FOUNDRY_VERSION: ${{ steps.taggen.outputs.FOUNDRY_VERSION }}
          SERVICE_VERSION: ${{ steps.taggen.outputs.TAG_SHA_DATE }}
        with:
          project: 3cpjhx94qv
          files: typescript/docker-bake.hcl
          push: true

      - name: Comment image tags on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const tag = '${{ steps.taggen.outputs.TAG }}';
            const tagShaDate = '${{ steps.taggen.outputs.TAG_SHA_DATE }}';
            const registry = 'gcr.io/abacus-labs-dev';
            const status = '${{ job.status }}';
            const statusEmoji = status === 'success' ? 'âœ…' : 'âŒ';

            const images = [
              { name: 'Rebalancer', image: 'hyperlane-rebalancer', emoji: 'â™»ï¸' },
              { name: 'Warp Monitor', image: 'hyperlane-warp-monitor', emoji: 'ðŸ•µï¸' },
              { name: 'CCIP Server', image: 'hyperlane-offchain-lookup-server', emoji: 'ðŸ”' },
              { name: 'KeyFunder', image: 'hyperlane-keyfunder', emoji: 'ðŸ”‘' },
              { name: 'TS Relayer', image: 'hyperlane-ts-relayer', emoji: 'ðŸš€' },
            ];

            const body = [
              '## âš™ï¸ Node Service Docker Images',
              '',
              '| Image | Tag | Status |',
              '|-------|-----|--------|',
              ...images.map(({ name, image, emoji }) =>
                `| ${emoji} ${name} | \`${registry}/${image}:${tagShaDate}\` | ${statusEmoji} |`
              ),
              '',
              '<details>',
              '<summary>All tags</summary>',
              '',
              '```',
              ...images.flatMap(i => [
                `${registry}/${i.image}:${tag}`,
                `${registry}/${i.image}:${tagShaDate}`,
              ]),
              '```',
              '</details>',
            ].join('\n');

            const marker = '<!-- typescript-docker-images -->';
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.pull_request.number }},
            });

            const existingComment = comments.find(c => c.body.includes(marker));
            const fullBody = `${marker}\n${body}`;

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: fullBody,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ github.event.pull_request.number }},
                body: fullBody,
              });
            }
