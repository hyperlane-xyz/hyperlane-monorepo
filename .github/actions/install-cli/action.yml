name: 'Install Hyperlane CLI'
description: 'Install the Hyperlane CLI by packaging from a local build'

inputs:
  ref:
    description: 'The Git ref to checkout'
    required: true
  no-cache:
    description: 'Whether to skip the cache'
    required: false
    default: false

runs:
  using: 'composite'
  steps:
    - name: Configure script shell for Windows
      if: runner.os == 'Windows'
      shell: bash
      run: echo "script-shell=bash" >> .npmrc

    - name: pnpm-build-with-cache
      if: inputs.no-cache == 'false'
      uses: ./.github/actions/pnpm-build-with-cache

    - name: Setup Foundry
      if: inputs.no-cache != 'false'
      uses: ./.github/actions/setup-foundry

    - name: Setup pnpm (no-cache path)
      if: inputs.no-cache != 'false'
      uses: pnpm/action-setup@v4

    # Pre-download tron-solc if not cached (Node 24 undici incompatibility)
    - name: Pre-download tron-solc (no-cache path)
      if: inputs.no-cache != 'false'
      shell: bash
      run: |
        TRON_SOLC_VERSION=0.8.22
        TRON_SOLC_DIR="$HOME/.tron/solc"
        mkdir -p "$TRON_SOLC_DIR"
        curl --retry 5 --retry-delay 5 --retry-all-errors -fsSL \
          "https://tronsuper.github.io/tron-solc-bin/bin/soljson_v${TRON_SOLC_VERSION}.js" \
          -o "$TRON_SOLC_DIR/soljson_v${TRON_SOLC_VERSION}.js"

    - name: pnpm-install-build-without-cache
      if: inputs.no-cache != 'false'
      shell: bash
      run: |
        pnpm install --frozen-lockfile
        pnpm run build

    - name: Pack the CLI
      shell: bash
      id: pack-cli
      run: pnpm -C typescript/cli pack

    - name: Install the packaged CLI
      shell: bash
      run: npm i -g typescript/cli/hyperlane-xyz-cli-*.tgz
