name: 'PNPM Build with Cache'
description: 'Run pnpm build using pnpm cache'

inputs:
  ref:
    description: 'The Git ref to checkout'
    required: true

runs:
  using: 'composite'
  steps:
    - name: pnpm-cache
      id: pnpm-cache
      uses: ./.github/actions/pnpm-cache

    # Always run install - pnpm needs to verify lockfile and set up symlinks even with cache
    # The cache makes this much faster by restoring node_modules and store
    - name: Install dependencies
      shell: bash
      env:
        CACHE_HIT: ${{ steps.pnpm-cache.outputs.cache-hit }}
      run: |
        pnpm install --frozen-lockfile
        # Only check for git changes if cache was not hit (cache miss means fresh install)
        if [ "$CACHE_HIT" != "true" ]; then
          CHANGES=$(git status -s --ignore-submodules | grep -v "results.sarif")
          if [[ ! -z $CHANGES ]]; then
            echo "Changes found: $CHANGES"
            git diff
            exit 1
          fi
        fi

    - name: Build
      shell: bash
      run: pnpm build
