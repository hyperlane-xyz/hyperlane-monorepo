name: 'PR Comment'
description: 'Create or update a PR comment with a specific tag.'

inputs:
  comment_tag:
    description: 'Tag to identify the comment (for updating)'
    required: true
  message:
    description: 'The message body to post in the comment.'
    required: true
  pr_number:
    description: 'The pull request number.'
    required: true
  github_token:
    description: 'GitHub token for authentication.'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Post or update PR comment
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github_token }}
        PR_NUMBER: ${{ inputs.pr_number }}
        COMMENT_TAG: ${{ inputs.comment_tag }}
        MESSAGE: ${{ inputs.message }}
      run: |
        TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S")
        SUMMARY=$(cat <<EOF
### $COMMENT_TAG

Published image tag:

\`$MESSAGE\`

*Last updated: $TIMESTAMP UTC*
EOF
)
        COMMENT_ID=$(gh api repos/${GITHUB_REPOSITORY}/issues/${PR_NUMBER}/comments --jq ".[] | select(.body | contains(\"$COMMENT_TAG\")) | .id")
        if [ -n "$COMMENT_ID" ]; then
          gh api repos/${GITHUB_REPOSITORY}/issues/comments/${COMMENT_ID} --method PATCH -F body="$SUMMARY"
        else
          gh pr comment $PR_NUMBER --body "$SUMMARY"
        fi
