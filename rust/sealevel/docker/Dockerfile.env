# Base environment for volume-mounted builds
# This image provides the Solana build environment without copying source code
# Use with build-mounted.sh for faster local development builds

FROM --platform=linux/amd64 rust@sha256:79892de83d1af9109c47a4566a24a0b240348bb8c088f1bccc52645c4c70ec39 AS builder

# Install dependencies
RUN apt-get update && apt-get install -y \
    git \
    gnutls-bin \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Reproducibility environment variables
ENV SOURCE_DATE_EPOCH=0
ENV CARGO_INCREMENTAL=0
ENV RUSTFLAGS="--cfg tokio_unstable"

# Install Solana CLI v1.14.20
ENV SOLANA_VERSION=1.14.20
RUN curl -sSfL https://release.solana.com/v1.18.20/install > /tmp/install.sh && \
    sed -i "s|^SOLANA_INSTALL_INIT_ARGS=.*|SOLANA_INSTALL_INIT_ARGS=v${SOLANA_VERSION}|" /tmp/install.sh && \
    chmod +x /tmp/install.sh && \
    /tmp/install.sh && \
    rm /tmp/install.sh

ENV PATH="/root/.local/share/solana/install/active_release/bin:${PATH}"

# Verify installation
RUN solana --version && cargo --version && rustc --version

WORKDIR /build

CMD ["/bin/bash"]
